<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Mon Profil - Archetype Guessr</title>

<style>
body {
    margin:0;
    font-family:'Segoe UI', sans-serif;
    background: linear-gradient(135deg, #fdfbfb, #ebedee);
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
}

.container {
    background:white;
    padding:40px;
    border-radius:20px;
    box-shadow:0 10px 30px rgba(0,0,0,0.1);
    max-width:600px;
    text-align:center;
}

h1 {
    margin-bottom:20px;
}

.archetype-name {
    font-size:28px;
    font-weight:bold;
    color:#6a5acd;
    margin:20px 0;
}

.description {
    color:#555;
    line-height:1.6;
}

button {
    margin-top:30px;
    padding:10px 20px;
    border:none;
    border-radius:10px;
    background:#6a5acd;
    color:white;
    font-weight:bold;
    cursor:pointer;
}

button:hover {
    background:#5848c2;
}
</style>
</head>

<body>

<div class="container">
  <h1>Votre Profil</h1>

  <h2>Infos personnelles</h2>
  <div id="personal-info"></div>

  <div class="archetype-name" id="archetype-name">
    Calcul en cours...
  </div>

  <div class="description" id="archetype-desc"></div>

  <button onclick="goHome()">Retour Accueil</button>
</div>

<script>


//chargement du profil utilisateur du type :
/*
let profile = {
  healthy: 0,
  finance: 0,
  productivite: 0,
  technologie: 0,
  developpement_personnel: 0,
  lifestyle: 0,
  culture: 0,
  sport_performance: 0,
  business: 0,
  societe: 0,
  couple: 0,
  celibataire: 0
};
*/
const tempsParArticle = JSON.parse(localStorage.getItem("tempsParArticle")) || {};
const profile = buildWeightedProfile();

let archetypesData = {};


//init
document.addEventListener("DOMContentLoaded", () => {
  console.log("RESULT VERSION 2");

  fetch('data/archetype.json')
    .then(res => res.json())
    .then(data => {

      archetypesData = data.archetypes;
      calculateArchetype();

    })
    .catch(err => {
      console.error("Erreur chargement archetypes :", err);
    });

});

function buildWeightedProfile() {

  const articles = JSON.parse(localStorage.getItem("articlesData")) || [];
  const tempsParArticle = JSON.parse(localStorage.getItem("tempsParArticle")) || {};
 

  let weightedProfile = {};

  articles.forEach(article => {

    const temps = tempsParArticle[article.id] || 0;

    let weight = 1;

    if (temps > 180) { // en sec
      weight = 2;
    } else if (temps > 40) { 
      weight = 1;
    } else {
      weight = 0.5;
    }

    article.tags.forEach(tag => {

      if (!weightedProfile[tag]) {
        weightedProfile[tag] = 0;
      }

      weightedProfile[tag] += weight;

    });

  });

  return weightedProfile;
}

//calcul de l'archetype
function calculateArchetype() {

  const viewedArticles = JSON.parse(localStorage.getItem("viewedArticles")) || [];

  let totalClicks = viewedArticles.length;

  if (totalClicks < 3) { // minimum 3 clicks sur article
    displayInsufficient(totalClicks);
    return;
  }

  let scores = [];

  for (let archetypeKey in archetypesData) {

    let archetype = archetypesData[archetypeKey];
    let score = 0;

    archetype.tags.forEach(tagCategory => {

      // on ignore couple et celibataire dans le classement
      if (tagCategory === "couple" || tagCategory === "celibataire") return;

      if (profile[tagCategory]) {
        score += profile[tagCategory];
      }

    });

    scores.push({
      key: archetypeKey,
      desc: archetype.desc,
      score: score
    });
  }

  // trier du plus grand au plus petit
  scores.sort((a, b) => b.score - a.score);

  // on garde les 3 premiers
  const top3 = scores.slice(0, 3);
  displayPersonalInfo()
  displayTop3(top3);

}

function displayPersonalInfo() {

  const personalDiv = document.getElementById("personal-info");

  const coupleScore = profile["couple"] || 0;
  const celibScore = profile["celibataire"] || 0;

  // Aucun des deux
  if (coupleScore === 0 && celibScore === 0) {
    personalDiv.innerHTML = "";
    return;
  }

  // on n'affiche rien
  if (coupleScore === celibScore) {
    personalDiv.innerHTML = "";
    return;
  }

  if ((coupleScore > celibScore)&&(coupleScore>3)) {
    personalDiv.innerHTML = "<p> Situation : En couple</p>";
  } else if ((coupleScore < celibScore)&&(celibScore>3)) {
    personalDiv.innerHTML = "<p> Situation : Célibataire</p>";
  }else {
    personalDiv.innerHTML = "";
  }
}
 

function displayInsufficient(totalClicks) {

  const nameEl = document.getElementById("archetype-name");
  const descEl = document.getElementById("archetype-desc");

  nameEl.innerText = "Profil en cours de construction";
  descEl.innerText = `Vous avez consulté ${totalClicks} article(s). Consultez au moins 10 articles pour révéler votre archétype.`;
}


//on affiche
function displayTop3(top3) {

  const nameEl = document.getElementById("archetype-name");
  const descEl = document.getElementById("archetype-desc");

  if (!top3 || top3.length < 3) {
    nameEl.innerText = "Profil insuffisant";
    descEl.innerText = "Consultez plus d'articles pour obtenir un résultat.";
    return;
  }

  // Nettoyage des noms (remplacer _ par espace + capitaliser)
  function formatName(name) {
    return name
      .replace(/_/g, " ")
      .replace(/\b\w/g, l => l.toUpperCase());
  }

  const top1name = formatName(top3[0].key);
  const top2name = formatName(top3[1].key);
  const top3name = formatName(top3[2].key);

  nameEl.innerText = `Vous êtes ${top1name}, ${top2name} et ${top3name}.`;

  descEl.innerHTML = `
    <p>Tout d'abord, ${top3[0].desc}</p>
    <p>De plus, ${top3[1].desc}</p>
    <p>On dit aussi de vous que ${top3[2].desc}</p>
  `;
}



function goHome() {
  window.location.href = "index.html";
}

</script>

</body>
</html>